<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/nav.css">
    <link rel="stylesheet" href="/css/dashboard.css">

    <title>Dashboard</title>
</head>
<body>

    <header>
        <nav class="navbar">
            <a href="#" class="nav-branding" >Ventilation Project - Group 5</a>

            <ul class="nav-menu">

                <li class="nav-item">
                    <a href="/dashboard" class="nav-link">Home</a>
                </li>

                <li class="nav-item">
                    <a href="/stats" class="nav-link">Sensors</a>
                </li>

                <li class="nav-item">
                    <a href="/userstats" class="nav-link">Users stats</a>
                </li>

                <li class="nav-item">
                    <a href="/logout" class="nav-link">Log out</a>
                </li>

            </ul>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>

            </div>
        </nav>
    </header>

    <!-- <div class="rotate-container">
        <img src="/public/fan.svg" alt="fan-svg" id="svg">
    </div> -->

    <main class="w-full px-3 py-32 relative flex flex-row border-b-2 border-r-2 border-l-2 border-indigo-300 rounded-b-2xl" id="main_content">
        <section class="w-1/3 flex flex-row items-center justify-center" >
            <object type="image/svg+xml" data="/fan.svg" class="fanSvg w-3/4 h-3/4" id="fan"></object>
        </section>

        <form action="/update" method="POST">
            <section class="w-2/3 flex flex-col items-center my-auto">
                <div>
                    <label class="switch">
                        <input type="checkbox" name="send_mode" value="auto" id="toggleBtn" onclick="toggle()">
                        <div class="slider round">
                            <span class="manual" id="toggle-text">Manual</span>
                            <span class="auto" id="toggle2-text">Auto</span>
                        </div>
                    </label>
                </div>
                <div id ="twoSliders">
                    <div class="slidercontainer" id="sliderPressureContainer">
                        <div class="mb-2">Pressure</div>
                        <input type="range" min="0" max="120" name="sliderPressure" class="sliderPressure" id="sliderPressure">
                        <div class="mt-1" id="displayPressure"></div>
                    </div>

                    <div class="slidercontainer" id="sliderSpeedContainer">
                        <div class="mb-2">Fan speed</div>
                        <input type="range" min="0" max="100" name="sliderSpeed" class="sliderSpeed" id="sliderSpeed">
                        <div class="mt-1" id="displaySpeed"></div>
                    </div>
                </div>

                <div id="divbutton">
                    <button id="mybutton"><span class="text">Set new mode or values</span></button>
                 </div>

                 </form>
            <div class="information">
                <br>
                <br>
                <br>
                <p class="text-left" id="mode"></p>
                <p class="text-left" id="pressure"></p>
                <p class="text-left" id="speed"></p>
                <p class="text-left" id="co2"></p>
                <p class="text-left" id="time"></p>

            </div>
        </section>
    </main>


    <script>

        let pressure_container = document.getElementById("sliderPressureContainer");
        let speed_container = document.getElementById("sliderSpeedContainer");
        speed_container.style.display = 'block';
        pressure_container.style.display = 'none';    

        // This part hides the range when the correct mode is hidden; manual -> fan speed , auto -> pressure
        function toggle(){
            if(document.getElementById("toggleBtn").checked === true) {
               // console.log("i am in auto!!!!!")
                pressure_container.style.display = 'block';
                speed_container.style.display = 'none';

            } else {
               // console.log("i am in manual!!!!!")
                pressure_container.style.display = 'none';
                speed_container.style.display = 'block';
            }
        }

        function startLiveUpdate(){


            setInterval(function (){
                fetch('http://localhost:8000/getFanPressure').then(function(response){
                    // console.log(response)
                    return response.json()
                }).then(function(data) {
                    var currentStatus = "auto"
                    if (!data.auto) currentStatus = "manual"

                    // date conversion 
                    let ISOdate = data.createdAt
                    date = ISOdate.split("T")[0]
                    time = ISOdate.split("T")[1]
                    time = time.substring(0, 8)
                    h = time.split(":")
                    n = (parseInt(h[0]) + 3) % 24
                    if (n.length === 1){
                    n= "0" + n;
                    }
                    time = n + ":" + h[1] + ":" + h[2]

                    document.getElementById("mode").innerHTML = "Current mode: " +  currentStatus 
                    document.getElementById("speed").innerHTML = "Current fan speed: " +  data.speed  + "%"
                    document.getElementById("pressure").innerHTML = "Current presssure: " +  data.pressure  + "Pa"
                    document.getElementById("co2").innerHTML = "Current co2: " +  data.co2  + "co2"
                    document.getElementById("time").innerHTML = "Current time: " +  date  + " "+ time


                }).catch( function(error){
                    console.log(error)
                })
            }, 2000);
        }

        document.addEventListener('DOMContentLoaded', function(){
            startLiveUpdate();
        })
        


        // rotate image
        const img = document.querySelector("#fan");
        let rtdeg = 0;
        // console.log(img);
        setInterval(()=> {
            rtdeg++;
            if (rtdeg == 360) rtdeg = 0;
            // img.style.transform = 'rotate("+rtdeg"deg)';
            img.style.transform = `rotate(${rtdeg}deg)`;
        }, 10)


        </script>
        <script src="/js/nav.js"></script>    
        <script src="/js/handler.js"></script> 


</body>
